var egret=window.egret,__reflect=this&&this.__reflect||function(e,t,a){e.__class__=t,a?a.push(t):a=[t],e.__types__=e.__types__?a.concat(e.__types__):a},__awaiter=this&&this.__awaiter||function(e,t,a,r){return new(a||(a=Promise))(function(n,i){function o(e){try{l(r.next(e))}catch(t){i(t)}}function s(e){try{l(r["throw"](e))}catch(t){i(t)}}function l(e){e.done?n(e.value):new a(function(t){t(e.value)}).then(o,s)}l((r=r.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function a(e){return function(t){return r([e,t])}}function r(a){if(n)throw new TypeError("Generator is already executing.");for(;l;)try{if(n=1,i&&(o=i[2&a[0]?"return":a[0]?"throw":"next"])&&!(o=o.call(i,a[1])).done)return o;switch(i=0,o&&(a=[0,o.value]),a[0]){case 0:case 1:o=a;break;case 4:return l.label++,{value:a[1],done:!1};case 5:l.label++,i=a[1],a=[0];continue;case 7:a=l.ops.pop(),l.trys.pop();continue;default:if(o=l.trys,!(o=o.length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){l=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){l.label=a[1];break}if(6===a[0]&&l.label<o[1]){l.label=o[1],o=a;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(a);break}o[2]&&l.ops.pop(),l.trys.pop();continue}a=t.call(e,l)}catch(r){a=[6,r],i=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}var n,i,o,s,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),"throw":a(1),"return":a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},__extends=this&&this.__extends||function(e,t){function a(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);a.prototype=t.prototype,e.prototype=new a},LoaderImageUtil=function(){function e(){}return Object.defineProperty(e,"instance",{get:function(){return this._instance||(this._instance=new e),this._instance},enumerable:!0,configurable:!0}),e.prototype.loaderImage=function(e,t){return __awaiter(this,void 0,void 0,function(){var a;return __generator(this,function(r){return a=new egret.ImageLoader,a.addEventListener(egret.Event.COMPLETE,function(e){var a=e.currentTarget,r=new egret.Texture;r._setBitmapData(a.data),Main.textrueMap[t]=r},this),a.load(e),[2]})})},e}();__reflect(LoaderImageUtil.prototype,"LoaderImageUtil");var Main=function(e){function t(){var t=e.call(this)||this;return t.rankItemList=[],t.gameData=[],t.scrollView=new egret.ScrollView,t.initGameData(),t.initRes(),t}return __extends(t,e),t.prototype.initGameData=function(){this.gameData=[];for(var e={openid:"",avatarUrl:"",nickname:"虚位以待",KVDataList:[{key:"gold",value:"0"}]},t=0;30>t;t++)this.gameData.push(e)},t.prototype.initRes=function(){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(a){switch(a.label){case 0:return Object.keys(t.textrueMap).length<1?[4,LoaderImageUtil.instance.loaderImage("resource/rank/xjj_backg_tcsd.png","itemBg")]:[3,8];case 1:return a.sent(),[4,LoaderImageUtil.instance.loaderImage("resource/rank/xjj_frame_paihwd.png","myitemBg")];case 2:return a.sent(),[4,LoaderImageUtil.instance.loaderImage("resource/rank/xjj_img_paih1.png","one")];case 3:return a.sent(),[4,LoaderImageUtil.instance.loaderImage("resource/rank/xjj_img_paih2.png","two")];case 4:return a.sent(),[4,LoaderImageUtil.instance.loaderImage("resource/rank/xjj_img_paih3.png","three")];case 5:return a.sent(),[4,LoaderImageUtil.instance.loaderImage("resource/rank/xjj_frame_djdi.png","jinbidi")];case 6:return a.sent(),[4,LoaderImageUtil.instance.loaderImage("resource/rank/xjj_icon_jsdj.png","rankdi")];case 7:a.sent(),a.label=8;case 8:return wx.onMessage(function(t){e.stageWidth=t.stageWidth,e.stageHeight=t.stageHeight,e.selfUserInfo?e.requestStorage(t):wx.getUserInfo({openIdList:["selfOpenId"],lang:"zh_CN",success:function(a){e.selfUserInfo=a.data&&1==a.data.length?a.data[0]:null,e.requestStorage(t)},fail:function(){console.log("获取个人信息错误")},complete:function(){}})}),[2]}})})},t.prototype.requestStorage=function(e){var t=this;if(e.isDisplay){this.rankType=e.rankType,1==e.rankType?wx.getFriendCloudStorage({keyList:["gold"],success:function(e){e.data&&(t.rankData=e.data,t.updataGameData()),t.runGame()},fail:function(e){console.log(e)},complete:function(){}}):2==e.rankType&&wx.getGroupCloudStorage({shareTicket:e.shareTicket,keyList:["gold"],success:function(e){e.data&&(t.rankData=e.data,t.updataGameData()),t.runGame()},fail:function(e){console.log(e)},complete:function(){}})}else this.cancelGame()},t.prototype.updataGameData=function(){var e=this;this.rankData.sort(function(a,r){var n=/[a-z,A-Z]{1,2}/g,i=/\d+/g,o=a.KVDataList[0].value,s=r.KVDataList[0].value,l=parseInt(o.match(i)[0]),c=parseInt(s.match(i)[0]),h=o.match(n)[0];null==h&&(h="");var d=s.match(n)[0];null==d&&(d="");var u=e.searchXiaBiao(t.units,h),g=e.searchXiaBiao(t.units,d);return h==d&&l==c?0:h==d?l>c?-1:1:h!=d?u>g?-1:1:void 0}),this.gameData.forEach(function(t,a){e.rankData&&a<e.rankData.length&&(e.gameData[a]=e.rankData[a])})},t.prototype.runGame=function(){var e=this,t=545,a=626,r=this.stageWidth-t>>1,n=this.stageHeight-a>>1,i=new egret.DisplayObjectContainer;this.scrollView.setContent(i),this.scrollView.x=r,this.scrollView.y=n,this.scrollView.width=t,this.scrollView.height=626,this.addChild(this.scrollView);var o=-1,s=1,l=15;this.gameData.forEach(function(t,a){if(t.avatarUrl==e.selfUserInfo.avatarUrl){var c=new PassRankItem(t,a,0);c.x=r,c.y=n+e.scrollView.height+18,e.addChild(c),o=a}var c=new PassRankItem(t,a,1);c.y=l+100*a,i.addChild(c),s++},this),-1==o&&this.rankData.forEach(function(t,a){if(t.avatarUrl==e.selfUserInfo.avatarUrl){var n=new PassRankItem(t,a,0);n.x=r,n.y=l-n.height,e.addChild(n)}},this)},t.prototype.searchXiaBiao=function(e,t){for(var a=e.length-1;a>=0;){if(e[a]===t)return a;a--}return-1},t.prototype.cancelGame=function(){for(var e=0,t=this.numChildren;t>e;e++)this.removeChildAt(0);this.scrollView.removeContent(),this.initGameData(),console.log("停止开放数据域")},t.units=["","K","M","B","T","aa","bb","cc","dd","ee","ff","gg","hh","ii","jj","kk","ll","mm","nn","oo","pp","qq","rr","ss","tt","uu","vv","ww","xx","yy","zz","AA","BB","CC","DD","EE","FF","GG","HH","II","JJ","KK","LL","MM","NN","OO","PP","QQ","RR","SS","TT","UU","VV","WW","XX","YY","ZZ"],t.textrueMap={},t}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var PassRankItem=function(e){function t(t,a,r){void 0===r&&(r=1);var n=e.call(this)||this;n.height=92,n.width=540;var i=new egret.Bitmap(Main.textrueMap.itemBg),o=new egret.Bitmap(Main.textrueMap.myitemBg);i.width=540,i.height=92,i.scale9Grid=new egret.Rectangle(15,15,0,0),n.addChild(i),0==r&&(i.texture=o.texture);var s=new egret.Bitmap(Main.textrueMap.rankdi);s.x=36,s.y=21,n.addChild(s);var l=new egret.TextField;return l.width=50,l.textAlign=egret.HorizontalAlign.CENTER,l.x=30,l.y=28,l.text=""+(a+1),l.textColor=16777215,l.size=24,n.addChild(l),n.refreshUI(t),n}return __extends(t,e),t.prototype.refreshUI=function(e){var t=this;if(this.itemData=e,e.avatarUrl&&""!=e.avatarUrl){var a=new egret.ImageLoader;a.addEventListener(egret.Event.COMPLETE,function(e){var a=e.currentTarget;if(a.data){var r=new egret.Texture;r._setBitmapData(a.data);var n=new egret.Bitmap(r);n.width=72,n.height=72,n.anchorOffsetX=36,n.anchorOffsetY=36,n.x=120,n.y=42,t.addChild(n)}},this),a.load(e.avatarUrl)}var r=new egret.TextField;r.x=170,r.y=30,r.text=this.getChar(this.itemData.nickname,12),r.textColor=8601373,r.size=24,this.addChild(r);var n=new egret.Bitmap(Main.textrueMap.jinbidi);n.scale9Grid=new egret.Rectangle(41,20,0,0),n.width=146,n.x=330,n.y=22,this.addChild(n);var i=new egret.TextField;i.x=360,i.y=30,i.textColor=16777215,i.text=""+this.itemData.KVDataList[0].value,i.size=24,this.addChild(i)},t.prototype.getChar=function(e,t){var a=new egret.ByteArray;return a.writeUTFBytes(e),a.length<=t?e:(a.position=0,a.readUTFBytes(t)+"··")},t}(egret.DisplayObjectContainer);__reflect(PassRankItem.prototype,"PassRankItem");var SelfPassRankItem=function(e){function t(t,a){var r=e.call(this)||this,n=new egret.Bitmap(Main.textrueMap.itemBg);if(n.width=532,r.addChild(n),n.alpha=0,3>a){var i=[Main.textrueMap.one,Main.textrueMap.two,Main.textrueMap.three],o=new egret.Bitmap(i[a]);o.x=90,o.y=10,o.rotation=-40,o.scaleX=.6,o.scaleY=.6,r.addChild(o)}var s=new egret.TextField;return s.width=50,s.textAlign=egret.HorizontalAlign.CENTER,s.x=30,s.y=25,s.text=""+(a+1),r.addChild(s),r.headMask=new egret.Shape,r.headMask.graphics.beginFill(49151,1),r.headMask.graphics.drawCircle(140,40,28),r.headMask.graphics.endFill(),r.addChild(r.headMask),r.refreshUI(t),r}return __extends(t,e),t.prototype.refreshUI=function(e){var t=this;if(this.itemData=e,e.avatarUrl&&""!=e.avatarUrl){var a=new egret.ImageLoader;a.addEventListener(egret.Event.COMPLETE,function(e){var a=e.currentTarget;if(a.data){var r=new egret.Texture;r._setBitmapData(a.data);var n=new egret.Bitmap(r);n.width=60,n.height=60,n.anchorOffsetX=30,n.anchorOffsetY=30,n.x=140,n.y=40,t.addChild(n),n.mask=t.headMask}},this),a.load(e.avatarUrl)}var r=new egret.TextField;r.x=190,r.y=30,r.text=""+this.itemData.nickname,r.textColor=9625067,this.addChild(r);var n=new egret.TextField;n.x=430,n.y=30,n.textColor=9625067,n.text=""+this.itemData.KVDataList[0].value,this.addChild(n)},t}(egret.DisplayObjectContainer);__reflect(SelfPassRankItem.prototype,"SelfPassRankItem"),window.Main=Main;